name: Notify WebProtege Deploy

on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed

jobs:
  notify:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub App Token (for webprotege-deploy)
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.PROTEGE_PROJECT_CLIENT_ID }}
          private-key: ${{ secrets.PROTEGE_PROJECT_CLIENT_SECRET }}
          owner: protegeproject
          repositories: webprotege-deploy
      
      - name: Trigger workflow_call in webprotege-deploy via GitHub API
        id: trigger-workflow
        run: |
          # Retrieve the output values from the previous workflow
          SERVICE="${{ github.event.workflow_run.outputs.service }}"
          VERSION="${{ github.event.workflow_run.outputs.version }}"
          
          # Echo the parameters
          echo "Service: $SERVICE"
          echo "Version: $VERSION"
      
          response=$(curl -s -w "%{http_code}" -X POST \
            -H "Authorization: token ${{ steps.app-token.outputs.token }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/protegeproject/webprotege-deploy/actions/workflows/update-compose.yml/dispatches \
            -d '{
                  "ref": "master-who",
                  "inputs": {
                    "service": "'"$SERVICE"'",
                    "version": "'"$VERSION"'",
                    "branch": "master-who"
                  }
                }')
      
          # Extract the HTTP status code and body
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')  # Remove the last line to get the body
      
          echo "HTTP Status Code: $http_code"
          echo "Response Body: $body"
      
          if [[ "$http_code" -lt 200 || "$http_code" -ge 300 ]]; then
            echo "Error: API call failed with status code $http_code"
            exit 1
          else
            echo "API call successful, status code: $http_code"
          fi
